<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<title>Home</title>
		<style type='text/css'>
			.row {

				line-height: 25px;
				width:calc(100% - 2px);
				width:-webkit-calc(100% - 2px);
				border-left: 1px solid #232323;
				border-right: 1px solid #232323;
				border-bottom: 1px solid #232323;
				overflow-x:scroll;
			}

			.btn {
				margin-top: 2px;
				/*margin-top: -2px;*/
				margin-right: 5px;
				float:right;
				line-height:20px;
				width:68px;
				height:20px;
				border-radius: 3px;
				color:#fff;
				cursor:pointer;
			}

			.removeBtn {
				background-color: #c0392b;
				border:1px solid #c0392b;
			}

			.updateBtn {
				background-color: #27ae60;
				border:1px solid #27ae60;
			}

			.downloadBtn {
				width:82px;
			}

			.docTitle {
				float:left;
				overflow:scroll;
				margin-left:2px;
				padding-top: 1px;
			}

			.titleNoError {
				max-width:550px;
			}

			.docCheckbox {
				margin-top: 7px;
				float:left;
				margin-left:6px;
			}

			.docTable {
				min-height: 25px;
				margin-top: -15px;
				width:-webkit-calc(100%-60px);
				width:calc(100%-60px);
				max-height: 550px;
				overflow:scroll;
			}

			.updateText {
				margin-left:8px;
				/*margin-top:1px;*/
			}

			.downloadText {
				margin-left:4px;
				/*margin-top:1px;*/
			}

			.removeText {
				margin-left:4px;
				/*margin-top:1px;*/
			}

			a {
				color:#4183c4;
				cursor:pointer;
				text-decoration: none;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}

			a:hover {
				text-decoration: underline;
			}

			.docsHeader {
				cursor:pointer;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}

			.alertCont {
				position:absolute;
				top:50%;
				left:50%;
				height:125px;
				width:350px;
				margin-top: -63px;
				margin-left: -200px;
				z-index: 5;
				background-color: #232323;
			}

			.alertTextCont {
				font-size: 15pt;
				color:#FFF;
				height:105px;
				width:330px;
				margin-top: 10px;
				margin-left: 10px;
				overflow: scroll;
				text-align: center;
			}

			.alertCloseBtn {
				color:#FFF;
				position:absolute;
				top:1px;
				right:1px;
				/*font-size: 120%;*/
				cursor:pointer;
			}

			.alertCloseBtn:hover {
				color:#c0392b;
			}

		</style>
	</head>
	<body style='font-family:helvetica;color:#232323;'>
		<!-- <center style='width:100%;'><h1>Home and Settings</h1></center> -->
		<div style = 'margin-left:2px;margin-top:15px;padding:0;'>
			<h3 id ='dledDocsHeader' class = 'docsHeader'>Downloaded Docs</h3>
			<div class = 'docTable' id = 'dlDocsTable'>
				<div style = 'height:5px;position:relative;width:100%;background-color:#232323;'></div>
				<div id = 'noDocs' style = 'height:25px;position:absolute;padding-left:5px;line-height:25px;'>
					No docs! Download some below in the <a onclick = 'highlightDl()'>Download Docs</a> section.
				</div>
			</div>

			<h3 id ='availDocs' class = 'docsHeader'>Download Docs</h3>
			<div class = 'docTable' id = 'availDocsTable'>
				<div style = 'height:5px;position:relative;width:100%;background-color:#232323;'></div>
			</div>
		</div>	
		<script type = 'text/javascript' src = 'js/jquery.js'></script>
		<script type = 'text/javascript' src = 'js/jquery.color.js'></script>
		<script type = 'text/javascript' src = 'js/spin.min.js'></script>
		<script type = 'text/javascript'>
			var fs = require('fs');
			var https = require('https');
			var http = require('http');
			var path = require('path');
			var unzip = require('decompress-zip');
			var rimraf = require(process.cwd() + '/deploy/js/rimraf.js');
			var dns = require('dns');
			window.__working = 0;

			loadPlugins();
			$('#dledDocsHeader').bind('click', function() {
				$('#dlDocsTable').toggle();
			});

			$('#availDocs').bind('click', function() {
				$('#availDocsTable').toggle();
			});

			function getDownloadableDocs() {
				var spinner = makeCustomSpinner();
				$(spinner.el).css('left', "170px");
				$(spinner.el).css('margin-top', "-11px");
				$('#availDocs').append(spinner.el);
				var a = isOnline(function() {
					var re = https.get('https://raw.githubusercontent.com/trusteedocs/trustee-docs-channel/master/docList.json', docListDownloaded);
					re.spinner = this.spinner;
				}, function(){
					setAvailableDocs(this.spinner);
				}, spinner.el);
			}

			function isOnline(cbt, cbf, spinner) {
				var a = https.get('https://github.com', function (re) {
					if (re) {
						this.cbt();
					}
					else {
						this.cbt();
					}
				});

				a.spinner = spinner;
				a.cbt = cbt;
				a.cbf = cbf;

				return this;
			}

			function docListDownloaded(response) {
				if (String(response.statusCode).charAt(0) != 2 && String(response.statusCode).charAt(0) != 3) {
					$(this.spinner).remove();
					showAlert("Error getting list of docs");
					return;
				}
				var file = fs.createWriteStream(process.cwd() + '/plugins/docList.json');
				response.pipe(file);
				file.spinner = this.spinner;
				file.on('finish', function() { //callback for when the file is finished being downloaded
					this.close(); 
					setAvailableDocs(this.spinner);
				});
			}

			function setAvailableDocs(spinner) {
				if (fs.existsSync(process.cwd() + '/plugins/docList.json')) {
					var dirs = getDirs();
					var info = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/docList.json').toString());
					info.forEach(function(o) {
						var repoName = o.repoURL.split('/')[4] + '-master';
						if (dirs.indexOf(repoName) == -1) {
							addAvailableDoc(o.name, o.repoURL);
						}
					});
				}
				else {
					showAlert("No internet and no archived copy of the documentation - could not fetch docs.")
				}
				if (spinner) {
					$(spinner).remove();
				}
			}

			function highlightDl() {
				$('#availDocs').css('background-color','#2ecc71');
				$('#availDocs').animate({'background-color': '#FFF'}, {duration:600});
			}

			function loadPlugins() {
				getDownloadableDocs();
				getPlugins(); 
			}

			function addAvailableDoc(name, url) {
				var row = $("<div>", {class:'row available'});
				var title = $("<div>", {class:'docTitle', text:name});
				var download = $("<div>", {class:'btn updateBtn downloadBtn'});
				download[0].row = row;
				download[0].url = url;
				var downloadText = $("<div>", {class:'downloadText',text:'Download'})
				download.bind('click', clickUpdateDocs);
				row.append(title);
				download.append(downloadText);
				row.append(download);
				$('#availDocsTable').append(row);

			}

			function addDocsToTable(name, active, dir, notFoundPath, reason) {
				if ($('#noDocs').length) {
					$('#noDocs').hide();
				}

				var row = $("<div>", {class:'row downloaded'});
				var input = $("<input>", {class:'docCheckbox', type:'checkbox'});
				if (active) {
					input.prop('checked', true);
				}
				else {
					input.prop('checked', false);
				}

				input.bind('click', function() {
					if ($(this).prop('checked')) {
						setActive(this.dir, 1);
					}
					else if ($(this).prop('checked') == false) {
						setActive(this.dir, 0);
					}
				});

				var title = $("<div>", {class:'docTitle', text:name});
				var update = $("<div>", {class:'btn updateBtn'});
				var updateText = $("<div>", {class:'updateText',text:'Update'})
				update.append(updateText);
				var remove = $("<div>", {class:'btn removeBtn'});
				var removeText = $("<div>", {class:'removeText',text:'Remove'});
				remove.append(removeText);

				row.append(input);
				row.append(title);
				row.append(update);
				row.append(remove);
				$('#dlDocsTable').append(row);
				//apply handlers if its found

				if (notFoundPath) {
					$(row).css("background-color", "#c0392b");
					remove.remove();
					update.remove();
					title.html(title.html() + ' - ' + reason + ': ' + notFoundPath + ". <b>Click to reload.</b>");
					row.css('cursor', 'pointer');
					row[0].dir = dir;
					row.bind('click', function() {
						var docList = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/docList.json').toString());
						var found;
						var dir = this.dir;
						var row = this;
						docList.forEach(function(o) {
							if (o.repoURL.split('/')[4] + '-master' == dir) {
								found = 1;
								var spinner = makeCustomSpinner();
								$('#dledDocsHeader').append(spinner.el)
								row.spinner = spinner.el;
								$(row.spinner).css('left', "200px");
								$(row.spinner).css('margin-top', "-11px");
								$(row).css('background-color', '#f1c40f');
								updatePlugin(o.repoURL, 1, row);
							}
						});

						if (!found) {
							showAlert('Documentation repository not found!');
						}
					});

					input.remove();
				}
				else {
					title.addClass('titleNoError');
					update[0].name = name;
					update[0].row = row;
					update[0].dir = dir;

					remove[0].name = name;
					remove[0].row = row;
					remove[0].dir = dir;

					input[0].dir = dir;

					update.bind('click', clickUpdateDocs);
					remove.bind('click', clickRemoveDocs);
				}

				return row;
			}

			function clickRemoveDocs() {
				rimraf.sync(process.cwd() + '/plugins' + this.dir);
				this.row.remove();
				if (!$('.downloaded').length) {
					$('#noDocs').hide();
				}

				var dir = this.dir;
				var name = this.name;
				if (fs.existsSync(process.cwd() + '/plugins/docList.json')) {
					var docList = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/docList.json').toString());
					var found;
					docList.forEach(function(o) {
						if (o.repoURL.split('/')[4] + '-master' == dir) {
							found = 1;
							addAvailableDoc(name, o.repoURL);
							parent.removeDocs(o);
						}
					});
	
					if (!found) {
						setAvailableDocs();
					}
				}
				else {
					setAvailableDocs();
				}
				//Remove docs
			}
			
			function differenceBetweenDays(day1, day2) {
				return Math.abs((day1 - day2)/(86400000)); //(1000 * 60 * 60 * 24));
			}

			function getPlugins() {
				var dirs = getDirs();
				var exemp = [];
				dirs.forEach(function(o) { //go through every directory in /plugins
					if (!checkAndAddDocs(o)) {
						exemp.push(o);
					}
				});

				parent.getDocsList(exemp);
			}

			function getDirs() {
				var d = fs.readdirSync(process.cwd() + "/plugins"); //get names of files / directories inside /plugins
				var dirs = []; //array to store all the directories within /plugins
				var currentPath = process.cwd() + "/plugins/"; //so that we don't have to constantly write the absolute path
				d.forEach(function(o) { //push every directory listed in the names inside of /plugins
					var stat = fs.statSync(currentPath + o);
					if (stat.isDirectory()) dirs.push(o);
				});

				return dirs;
			}

			function setActive(dir, state) {
				if (dir.charAt(0) != '/') {
					dir = '/' + dir;
				}
				var info = JSON.parse(fs.readFileSync(process.cwd() + '/plugins' + dir + "/info.json").toString());
				info.active = state;
				fs.writeFileSync(process.cwd() + '/plugins/' + dir + "/info.json", JSON.stringify(info));
				if (state == 0) {
					parent.removeDocs(dir);
				}
				else {
					parent.addDocs(dir);
				}
			}

			function verifyDocset(currentPath, dir) {
				var info = JSON.parse(fs.readFileSync(currentPath + dir + "/info.json").toString()); //get info file
				if (typeof(info.name) != 'string') return false;
				if (typeof(info.repoURL) != 'string') return false;
				if (typeof(info.docsURL) != 'string') return false;

				if (!fs.existsSync(currentPath + dir + '/output.json')) return false;
				//  var info = JSON.parse(fs.readFileSync(currentPath + dir + '/output.json').toString());
				//go into more detail about this later on to verify docs
				return true;
			}

			function checkAndAddDocs(dir, active) {
				if (active) {
					setActive(dir, 1);
				}
				else if (active == 0) {
					setActive(dir, 0);	
				}

				var currentPath = process.cwd() + "/plugins";
				if (dir.charAt(0) != '/') {
					dir = '/' + dir;
				}

				if (fs.existsSync(currentPath + dir + "/info.json")) { //if the info file exists, proceed
					var info = JSON.parse(fs.readFileSync(currentPath + dir + "/info.json").toString()); //get info file
					if (verifyDocset(currentPath, dir)) {
						if (differenceBetweenDays(new Date(), new Date(info.lastUpdated)) > 25) { //if it has been 30 days since the plugin has last been updated, update the plugin
							updatePlugin(info.repoURL, info.active);
						}
					}
					else {
						//err
						addDocsToTable(info.name, 0, dir.substr(1), dir, "info.json formatted incorrectly");
						return false;
					}

					addDocsToTable(info.name, info.active, dir);
				}
				else {
					//if err, make row showing that the path is invalid in the list of plugins
					//add in reload thing later
					addDocsToTable(dir.substr(1), 0, dir.substr(1), dir, "No info.json file found");
					return false;
				}

				return true;
			}
			
			function showAlert(text) {
				var alertCont = $('<div>', {class:'alertCont'});
				var alertTextCont = $('<div>', {class:'alertTextCont', text:text});
				var closeBtn = $('<i>', {class:'fa fa-times alertCloseBtn'});
				closeBtn[0].div = alertCont;
				closeBtn.bind('click', function(e) {
					this.div.remove();
				});
				alertCont.append(closeBtn);
				alertCont.append(alertTextCont);
				$('body').append(alertCont);
			}

			function updatePlugin(repoURL, active, div) { //repoURL - string containing url :: info - dict containing the info.json file of the plugin to update. div - the div that the update button is in 
				var checkOnline = isOnline(function(){
					window.__working++;
					downloadRepo("https://codeload.github.com/" + this.repoURL.split('/')[3] + "/" + this.repoURL.split('/')[4] + "/zip/master", this.active, this.div);
				}, function(){
					showAlert("Can't access internet!");
					$(this.div.spinner).remove();
				});

				checkOnline.repoURL = repoURL;
				checkOnline.active = active;
				checkOnline.div = div;
			}

			function downloadRepo(url, active, div) {
				var filename = url.split('/')[4] + '.zip';
				var file = fs.createWriteStream(process.cwd() + '/plugins/' + filename);
				file.active = active;
				file.filename = filename;
				file.div = div;
				request = https.get(url, endDownloadingRepo);
				request.file = file;
			}

			function endDownloadingRepo(response) {
				if (String(response.statusCode).charAt(0) != 2 && String(response.statusCode).charAt(0) != 3) {
					showAlert("Error getting url " + url);
					rimraf.sync(process.cwd() + '/plugins/'  + this.filename); //delete zip file
					window.__working--;
					return;
				}
				response.pipe(this.file);
				this.file.on('finish', function() { //callback for when the file is finished being downloaded
					this.close(); 
					// var extractor = unzip.Extract({ path: process.cwd() + '/plugins/'});
					var extractor = new unzip(process.cwd() + '/plugins/'  + this.filename);
					extractor.__filename = this.filename;
					extractor.__div = this.div;
					extractor.__active = this.active;
					extractor.on('error', function(err) {
						throw err;
						window.__working--;
					});

					extractor.on('extract', function(log) {
						rimraf.sync(this.filename); //delete zip file
						var dirName = this.__filename.substr(0, this.__filename.length - 4) + '-master';
						if (fs.existsSync(process.cwd() + '/plugins/' + dirName + '/info.json')) {
							var info = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/' + dirName + '/info.json').toString());
							info.lastUpdated = JSON.stringify(new Date());
							if (info.active == undefined) {
								this.__active = 1;
								info.active = 1;
							}

							fs.writeFileSync(process.cwd() + '/plugins/' + dirName + '/info.json', JSON.stringify(info));
							window.__working--;
							if (this.__div) {
								if ($(this.__div).html() == '<div class="downloadText">Download</div>') {
									$(this.__div.spinner).remove();
									this.__div.row.remove();
									checkAndAddDocs(dirName, this.__active);
								}
								else if (this.__div.className == 'row') {
									$(this.__div.spinner).remove();
									$(this.__div).remove();
									checkAndAddDocs(dirName, this.__active);
								}
								else {
									$(this.__div.spinner).remove();
								}
							}
							else {
								checkAndAddDocs(dirName, this.__active);
							}
						}
					});

					extractor.extract({
						path: process.cwd() + '/plugins/',
						filter: function (file) {
							return file.type !== "SymbolicLink";
						}
					});
				});
			}

			function getExtension(filename) {
				var ext = path.extname(filename||'').split('.');
				return ext[ext.length - 1];
			}

			function isFileInDirectory(a, b) { //directory, file 
				if (!fs.existsSync(a)) {
					return false;
				}
				var previouslyExisted = 1;
				if (!fs.existsSync(b)) { //if it didn't previously exist
					try {
						fs.writeFileSync(b, '') //make a few file
						previouslyExisted = 0;
					}
					catch (err) {
						throw err;
					}
				}
				if (b.indexOf(a) == 0) {
					var ap = fs.realpathSync(a); //get true paths
					var bp = fs.realpathSync(b);
					if (!previouslyExisted) {
						rimraf.sync(b); //if it didn't previously exist, delete it
					}
					if (bp.indexOf(ap) == 0) {
						return true;
					}
					else {
						return false ;
					}	
				}
				if (!previouslyExisted) {
					rimraf.sync(b); //if it didn't previously exist, delete it
				}
				return false;
			}

			//should be in index.html for the actual parsing
			function getDocs() {
				var dirs = [];
				var currentPath = process.cwd() + "/plugins/";
				var overallInfo = JSON.parse(fs.readFileSync(process.cwd() + "/plugins/").toString());
				var docs = [];

				overallInfo.forEach(function(o) {
					docs.push(o.folder);
				})

				dirs.forEach(function(o) {
					var foldersInDocs = fs.readdirSync(currentPath + o);
					if (foldersInDocs.indexOf('output') != -1) {
						if (fs.statSync(currentPath + o + '/output/').isDirectory()) {
							var itemsInOutput = fs.readdirSync(currentPath + o + '/output/');
							if (itemsInOutput.indexOf('output.json') != -1) {
								if (!fs.statSync(currentPath + o + '/output/output.json').isDirectory()) {
									docs.push(JSON.parse(fs.readFileSync(currentPath + o + '/output/output.json').toString()));
								}
							}
							else {
								itemsInOutput.forEach(function(file) {
									if (getExtension(currentPath + o + '/output/' + file) == "json") {
										docs.push(JSON.parse(fs.readFileSync(currentPath + o + '/output/' + file).toString()));
									}
								})
							}
						}
					}
				});

				return docs;
			}

			function getExtension(filename) {
				var ext = path.extname(filename||'').split('.');
				return ext[ext.length - 1];
			}

			function clickUpdateDocs() {
				var spinner = makeCustomSpinner();
				this.row.append(spinner.el);
				this.spinner = spinner.el;
				var url;
				if (this.url) {
					$(spinner.el).css('right', '112px');
					url = this.url;
				}
				else {
					url = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/' + this.dir + "/info.json").toString()).repoURL;
				}

				updatePlugin(url, 1, this);
				//
			}

			function makeCustomSpinner() {
				var opts = {
					lines: 10, // The number of lines to draw
					length: 5, // The length of each line
					width: 3, // The line thickness
					radius: 3, // The radius of the inner circle
					corners: 2, // Corner roundness (0..1)
					rotate: 0, // The rotation offset
					direction: 1, // 1: clockwise, -1: counterclockwise
					speed: 1, // Rounds per second
					trail: 60, // Afterglow percentage
					shadow: false, // Whether to render a shadow
					hwaccel: false, // Whether to use hardware acceleration
					className: 'spinner', // The CSS class to assign to the spinner
					zIndex: 2e9, // The z-index (defaults to 2000000000)
					top: 'auto', // Top position relative to parent in px
					left: 'auto' // Left position relative to parent in px
				};

				var spinner = new Spinner(opts).spin();
				// $(spinner.el).css('position', 'abso');
				$(spinner.el).css('right', '175px');
				$(spinner.el).css('margin-top', '12px');
				$(spinner.el).css('background-color', '#FFFFFF');
				// $(spinner.el).css('bottom', '9px');
				return spinner;
			}
		</script>
	</body>
</html>
