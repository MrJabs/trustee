<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<title>Home</title>
		<style type='text/css'>
			.row {
				height:25px;
				padding-top: 6px;
				width:calc(100% - 2px);
				width:-webkit-calc(100% - 2px);
				border-left: 1px solid #232323;
				border-right: 1px solid #232323;
				border-bottom: 1px solid #232323;
				overflow:scroll;
			}

			.btn {
				margin-top: -2px;
				margin-right: 5px;
				float:right;
				line-height:20px;
				width:68px;
				height:20px;
				border-radius: 3px;
				color:#fff;
				cursor:pointer;
			}

			.removeBtn {
				background-color: #c0392b;
				border:1px solid #c0392b;
			}

			.updateBtn {
				background-color: #27ae60;
				border:1px solid #27ae60;
			}

			.docTitle {
				float:left;
				margin-left:2px;
				padding-top: 1px;
			}

			.docCheckbox {
				float:left;
				margin-left:6px;
			}

			.docTable {
				margin-top: -15px;
				width:-webkit-calc(100%-60px);
				width:calc(100%-60px);
				max-height: 550px;
				overflow:scroll;
			}

			.updateText {
				margin-left:8px;
				/*margin-top:1px;*/
			}

			.removeText {
				margin-left:4px;
				/*margin-top:1px;*/
			}

			#dledDocsHeader {
				cursor:pointer;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
		</style>
	</head>
	<body style='font-family:helvetica;color:#232323;'>
		<!-- <center style='width:100%;'><h1>Home and Settings</h1></center> -->
		<div style = 'margin-left:2px;margin-top:15px;padding:0;'>
			<h3 id ='dledDocsHeader'>Downloaded Docs</h3>
			<div class = 'docTable'>
				<div style = 'height:5px;position:relative;width:100%;background-color:#232323;'></div>
			</div>
		</div>	
		<script type = 'text/javascript' src = 'js/jquery.js'></script>
		<script type = 'text/javascript' src = 'js/spin.min.js'></script>
		<script type = 'text/javascript'>
			var fs = require('fs');
			var https = require('https');
			var http = require('http');
			var path = require('path');
			var unzip = require('unzip');
			var rimraf = require(process.cwd() + '/deploy/js/rimraf.js');

			// addDocsToTable('Python 2.7', 1);

			$('#dledDocsHeader').bind('click', function(){
				$('.docTable').slideToggle({
					easing:'linear',
					duration:300
				});
			});

			function loadPlugins() {
				doesInfoFileExist(); //make sure that the overall plugins.json file exists
				getPlugins(); //get the plugins from the plugins.json file, make sure that they exist / work, and reload plugins that need reloading.
			}

			function addDocsToTable(name, active, dir, notFoundPath) {
				var row = $("<div>", {class:'row'});
				var input = $("<input>", {class:'docCheckbox', type:'checkbox'});
				if (active) {
					input.prop('checked', true);
				}
				else {
					input.prop('checked', false);
				}
				var title = $("<div>", {class:'docTitle', text:name});
				var update = $("<div>", {class:'btn updateBtn'});
				var updateText = $("<div>", {class:'updateText',text:'Update'})
				update.append(updateText);
				var remove = $("<div>", {class:'btn removeBtn'});
				var removeText = $("<div>", {class:'removeText',text:'Remove'});
				remove.append(removeText);

				row.append(input);
				row.append(title);
				row.append(update);
				row.append(remove);
				$('.docTable').append(row);
				//apply handlers if its found

				if (notFoundPath) {
					$(row).css("background-color", "#c0392b");
					remove.remove();
					update.remove();
					title.html(title.html() + ' - DOCS NOT FOUND. Not found: ' + notFoundPath);
					input.remove();
				}
				else {
					update[0].name = name;
					update[0].row = row;
					update[0].dir = dir;

					remove[0].name = name;
					remove[0].row = row;
					remove[0].dir = dir;

					update.bind('click', updateDocs);
					remove.bind('click', removeDocs);
				}
			}



			function removeDocs() {
				rimraf.sync(process.cwd() + '/plugins' + this.dir);
				this.row.remove();
				//Remove docs
			}
			
			function differenceBetweenDays(day1, day2) {
				return Math.abs((day1 - day2)/(86400000)); //(1000 * 60 * 60 * 24));
			}

			function getPlugins() {
				var d = fs.readdirSync(process.cwd() + "/plugins"); //get names of files / directories inside /plugins
				var dirs = []; //array to store all the directories within /plugins
				var currentPath = process.cwd() + "/plugins/"; //so that we don't have to constantly write the absolute path
				d.forEach(function(o){ //push every directory listed in the names inside of /plugins
					var stat = fs.statSync(currentPath + o);
					if (stat.isDirectory()) dirs.push(o);
				});

				dirs.forEach(function(o){ //go through every directory in /plugins
					checkAndAddDocs(o);
				});
			}

			function setActive(dir, state) {
				var info = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/' + dir + "/info.json").toString());
				info.active = state;
				fs.writeFileSync(process.cwd() + '/plugins/' + dir + "/info.json", JSON.stringify(info));
			}

			function verifyJSON(info) {
				if (typeof(info.name) != 'string') return false;
				if (typeof(info.repoURL) != 'string') return false;
				if (typeof(info.docsURL) != 'string') return false;
				return true;
			}

			function checkAndAddDocs(dir, active) {
				if (active) {
					setActive(dir, 1);
				}
				else if (active == 0) {
					setActive(dir, 0);	
				}

				var currentPath = process.cwd() + "/plugins";
				if (dir.charAt(0) != '/') {
					dir = '/' + dir;
				}
				if (fs.existsSync(currentPath + dir + "/info.json")) { //if the info file exists, proceed
					var info = JSON.parse(fs.readFileSync(currentPath + dir + "/info.json").toString()); //get info file
					if (verifyJSON(info)) {
						if (differenceBetweenDays(new Date(), new Date(info.lastUpdated)) > 25) { //if it has been 30 days since the plugin has last been updated, update the plugin
							updatePlugin(info.repoURL, info.active);
						}
					}
					else {
						//err
						addDocsToTable(info.name, info.active, dir, currentPath + dir);
					}

					addDocsToTable(info.name, info.active, dir);
				}
				else {
					//if err, make row showing that the path is invalid in the list of plugins
					//add in reload thing later
					addDocsToTable(info.name, info.active, dir, currentPath + dir);
				}
			}

			checkAndAddDocs("python-docs-trustee-master");

			function updatePlugin(repoURL, active, div) { //repoURL - string containing url :: info - dict containing the info.json file of the plugin to update. (optional) div - row for the container div in the GUI (optional)
				downloadRepo("https://codeload.github.com/" + repoURL.split('/')[3] + "/" + repoURL.split('/')[4] + "/zip/master", active, div);
			}

			function downloadRepo(url, active, div) {
				var filename = url.split('/')[4] + '.zip';
				var file = fs.createWriteStream(process.cwd() + '/plugins/' + filename);
				file.active = active;
				file.filename = filename;
				file.div = div;
				request = https.get(url, beginDocsDL);
				request.file = file;
			}

			function beginDocsDL(response) {

				if (String(response.statusCode).charAt(0) != 2 && String(response.statusCode).charAt(0) != 3) {
					alert("Error getting url " + url);
					rimraf.sync(process.cwd() + '/plugins/'  + this.filename); //delete zip file
					return;
				}
				response.pipe(this.file);
				this.file.on('finish', function() { //callback for when the file is finished being downloaded
					this.close(); 
					fs.createReadStream(process.cwd() + '/plugins/'  + this.filename).pipe(unzip.Extract({ path: process.cwd() + '/plugins/'}));  //file into /plugins/, overwriting any previous file
					rimraf.sync(process.cwd() + '/plugins/'  + this.filename); //delete zip file
					var dirName = this.filename.substr(0, this.filename.length - 4) + '-master';
					if (fs.existsSync(process.cwd() + '/plugins/' + dirName + '/info.json')) {
						var info = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/' + dirName + '/info.json').toString());
						var file = fs.createWriteStream(process.cwd() + '/plugins/' + dirName + '/docs.zip');
						file.div = this.div;
						var prot = info.docsURL.indexOf('https') == 0 ? https : http;
						var request = prot.get(info.docsURL, docsDownloaded);
						request.file = file;
						file.dir = dirName;
						file.info = info;
						file.active = this.active;
					}
					else {
						rimraf.sync(process.cwd() + '/plugins/' + dirName);
						alert('No info.json file in ' + dirName);
						return;
					}
				});
			}

			function docsDownloaded(response) {

				if (String(response.statusCode).charAt(0) != 2 && String(response.statusCode).charAt(0) != 3) {
					alert("Error getting url " + this.file.info.docsURL);
					rimraf.sync(process.cwd() + '/plugins/'  + this.file.dir); //delete plugins
					return;
				}
				response.pipe(this.file);
				this.file.on('finish', function() { //callback for when the file is finished being downloaded

					this.close(); 
					fs.createReadStream(process.cwd() + '/plugins/'  + this.dir + '/docs.zip').pipe(unzip.Extract({ path: process.cwd() + '/plugins/' + this.dir})); //file into /plugins/, overwriting any previous file
					rimraf.sync(process.cwd() + '/plugins/'  + this.dir + '/docs.zip'); //delete zip file
					this.info.lastUpdated = JSON.stringify(new Date());
					if (this.info.active == undefined) {
						this.active = 1;
						this.info.active = 1;
					}
					if (this.div) {
						$(this.div.spinner).remove();
						fs.writeFileSync(process.cwd() + '/plugins/' + this.dir + '/info.json', JSON.stringify(this.info));
						return;
					}

					fs.writeFileSync(process.cwd() + '/plugins/' + this.dir + '/info.json', JSON.stringify(this.info));
					checkAndAddDocs(this.dir, this.active);
				});
			}

			function getExtension(filename) {
				var ext = path.extname(filename||'').split('.');
				return ext[ext.length - 1];
			}

			function updatePluginsJSON(name, modifications) {
				var JSONToWrite = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/plugins.json').toString());
				JSONToWrite.forEach(function(o){
					if (o.name == name) {
						for (var i in modifications) {
							o[i] = modifications[i];
						}
						fs.writeFileSync(process.cwd() + '/plugins/plugins.json', JSON.stringify(JSONToWrite));
						return;
					}
				});

				JSONToWrite.push({
					folder:modifications.name,
					name:modifications.name,
					executable:modifications.executable,
					lastUpdated:modifications.lastUpdated,
					activated:1
				});

				fs.writeFileSync(process.cwd() + '/plugins/plugins.json', JSON.stringify(JSONToWrite));
				return;
			}

			function isFileInDirectory(a, b) { //directory, file 
				if (!fs.existsSync(a)) {
					return false;
				}
				var previouslyExisted = 1;
				if (!fs.existsSync(b)) { //if it didn't previously exist
					try {
						fs.writeFileSync(b, '') //make a few file
						previouslyExisted = 0;
					}
					catch (err) {
						throw err;
					}
				}
				if (b.indexOf(a) == 0) {
					var ap = fs.realpathSync(a); //get true paths
					var bp = fs.realpathSync(b);
					if (!previouslyExisted) {
						rimraf.sync(b); //if it didn't previously exist, delete it
					}
					if (bp.indexOf(ap) == 0) {
						return true;
					}
					else {
						return false ;
					}	
				}
				if (!previouslyExisted) {
					rimraf.sync(b); //if it didn't previously exist, delete it
				}
				return false;
			}

			function doesInfoFileExist() {
				if (!fs.existsSync(process.cwd() + '/plugins/plugins.json')) {
					fs.writeFileSync(process.cwd() + '/plugins/plugins.json', '{plugins:[]}');
				}
			}

			//should be in index.html for the actual parsing
			function getDocs() {
				var dirs = [];
				var currentPath = process.cwd() + "/plugins/";
				var overallInfo = JSON.parse(fs.readFileSync(process.cwd() + "/plugins/").toString());
				var docs = [];

				overallInfo.forEach(function(o) {
					docs.push(o.folder);
				})

				dirs.forEach(function(o) {
					var foldersInDocs = fs.readdirSync(currentPath + o);
					if (foldersInDocs.indexOf('output') != -1) {
						if (fs.statSync(currentPath + o + '/output/').isDirectory()) {
							var itemsInOutput = fs.readdirSync(currentPath + o + '/output/');
							if (itemsInOutput.indexOf('output.json') != -1) {
								if (!fs.statSync(currentPath + o + '/output/output.json').isDirectory()) {
									docs.push(JSON.parse(fs.readFileSync(currentPath + o + '/output/output.json').toString()));
								}
							}
							else {
								itemsInOutput.forEach(function(file){
									if (getExtension(currentPath + o + '/output/' + file) == "json") {
										docs.push(JSON.parse(fs.readFileSync(currentPath + o + '/output/' + file).toString()));
									}
								})
							}
						}
					}
				});
				console.log(docs);
				return docs;
			}

			function getExtension(filename) {
				var ext = path.extname(filename||'').split('.');
				return ext[ext.length - 1];
			}

			function updateDocs() {
				var spinner = makeCustomSpinner();
				this.row.append(spinner.el);
				this.spinner = spinner.el;
				var info = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/' + this.dir + "/info.json").toString());
				updatePlugin(info.repoURL, info.active, this);
				//
			}

			function makeCustomSpinner() {
				var opts = {
					lines: 10, // The number of lines to draw
					length: 5, // The length of each line
					width: 3, // The line thickness
					radius: 3, // The radius of the inner circle
					corners: 2, // Corner roundness (0..1)
					rotate: 0, // The rotation offset
					direction: 1, // 1: clockwise, -1: counterclockwise
					speed: 1, // Rounds per second
					trail: 60, // Afterglow percentage
					shadow: false, // Whether to render a shadow
					hwaccel: false, // Whether to use hardware acceleration
					className: 'spinner', // The CSS class to assign to the spinner
					zIndex: 2e9, // The z-index (defaults to 2000000000)
					top: 'auto', // Top position relative to parent in px
					left: 'auto' // Left position relative to parent in px
				};

				var spinner = new Spinner(opts).spin();
				// $(spinner.el).css('position', 'abso');
				$(spinner.el).css('right', '175px');
				$(spinner.el).css('margin-top', '8px');
				$(spinner.el).css('background-color', '#FFFFFF');
				// $(spinner.el).css('bottom', '9px');
				return spinner;
			}
		</script>
	</body>
</html>
