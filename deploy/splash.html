<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<title>Home</title>
		<style type='text/css'>
			.row {
				height:25px;
				padding-top: 6px;
				width:calc(100% - 2px);
				width:-webkit-calc(100% - 2px);
				border-left: 1px solid #232323;
				border-right: 1px solid #232323;
				border-bottom: 1px solid #232323;
				overflow:scroll;
			}

			.btn {
				margin-top: -2px;
				margin-right: 5px;
				float:right;
				line-height:20px;
				width:68px;
				height:20px;
				border-radius: 3px;
				color:#fff;
				cursor:pointer;
			}

			.removeBtn {
				background-color: #c0392b;
				border:1px solid #c0392b;
			}

			.updateBtn {
				background-color: #27ae60;
				border:1px solid #27ae60;
			}

			.docTitle {
				float:left;
				margin-left:2px;
				padding-top: 1px;
			}

			.docCheckbox {
				float:left;
				margin-left:6px;
			}

			.docTable {
				margin-top: -15px;
				width:-webkit-calc(100%-60px);
				width:calc(100%-60px);
				max-height: 550px;
				overflow:scroll;
			}

			.updateText {
				margin-left:8px;
				/*margin-top:1px;*/
			}

			.removeText {
				margin-left:4px;
				/*margin-top:1px;*/
			}

			#dledDocsHeader {
				cursor:pointer;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
		</style>
	</head>
	<body style='font-family:helvetica;color:#232323;'>
		<!-- <center style='width:100%;'><h1>Home and Settings</h1></center> -->
		<div style = 'margin-left:2px;margin-top:15px;padding:0;'>
			<h3 id ='dledDocsHeader'>Downloaded Docs</h3>
			<div class = 'docTable'>
				<div style = 'height:5px;position:relative;width:100%;background-color:#232323;'></div>
			</div>
		</div>	
		<script type = 'text/javascript' src = 'js/jquery.js'></script>
		<script type = 'text/javascript' src = 'js/spin.min.js'></script>
		<script type = 'text/javascript'>
			var fs = require('fs');
			var http = require('http');
			var path = require('path');
			var vm = require('vm');
			var util = require('util');
			var sandbox = require('node-sandbox').Sandbox;
			var unzip = require('unzip');

			addDocsToTable('Python 2.7', 1);

			$('#dledDocsHeader').bind('click', function(){
				$('.docTable').slideToggle({
					easing:'linear',
					duration:300
				});
			});

			function loadPlugins() {
				doesInfoFileExist();
				var potentialPlugins = getPotentialPlugins();
				// var pluginData = getDocs();
				// var plugins = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/plugins.json').toString());
			}

			function addDocsToTable(name, active, notFoundPath) {
				var row = $("<div>", {class:'row'});
				var input = $("<input>", {class:'docCheckbox', type:'checkbox'});
				if (active) {
					input.prop('checked', true);
				}
				else {
					input.prop('checked', false);
				}
				var title = $("<div>", {class:'docTitle', text:name});
				var update = $("<div>", {class:'btn updateBtn'});
				var updateText = $("<div>", {class:'updateText',text:'Update'})
				update.append(updateText);
				var remove = $("<div>", {class:'btn removeBtn'});
				var removeText = $("<div>", {class:'removeText',text:'Remove'});
				remove.append(removeText);

				row.append(input);
				row.append(title);
				row.append(update);
				row.append(remove);
				$('.docTable').append(row);
				//apply handlers if its found

				if (notFoundPath) {
					$(row).css("background-color", "#c0392b");
					remove.remove();
					update.remove();
					title.html(title.html() + ' - DOCS NOT FOUND. Not found: ' + process.cwd() + notFoundPath);
					input.remove();
				}
				else {
					update[0].name = name;
					update[0].row = row;

					remove[0].name = name;
					remove[0].row = row;

					update.bind('click', updateDocs);
					remove.bind('click', removeDocs);
				}
			}

			function removeDocs() {
				this.row.remove();
				//Remove docs
			}

			getPotentialPlugins();
			
			function differenceBetweenDays(day1, day2) {
				return Math.abs((day1 - day2)/(86400000)); //(1000 * 60 * 60 * 24));
			}

			function getPotentialPlugins() {
				var d = fs.readdirSync(process.cwd() + "/plugins/");
				var dirs = [];
				var currentPath = process.cwd() + "/plugins/";
				var overallInfo = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/plugins.json').toString());
				d.forEach(function(o){
					var stat = fs.statSync(currentPath + o);
					if (stat.isDirectory()) dirs.push(o);
				});

				dirs.forEach(function(o){
					if (fs.existsSync(currentPath + o + "/info.json")) {
						var info = fs.readFileSync(currentPath + o + "/info.json").toString();
						info = JSON.parse(info);
						// for (var i in overallInfo) {
						// 	if (overallInfo.name )
						// }
						overallInfo.forEach(function(doc) {
							if (info.name == doc.name) {
								if (differenceBetweenDays(new Date(), new Date(doc.lastUpdated)) > 25) { //if it has been 30 days since the plugin has last been updated, update the plugin
									beginParsing(info, currentPath + o);
								}
							}
						});
					}
					else {
						console.log('No info.json! in ' + currentPath + o);
					}
				});
			}

			function beginParsing(info, currentPath) {
				//download docs into the plugin's folder
				// downloadFile(info.urlToDocs, currentPath);
				download(info.urlToDocs, currentPath, info);
			}

			function download(url, dest, info, currentPath, cb) {
				var file = fs.createWriteStream(dest + '/' + url.split('/')[url.split('/').length - 1]);
				file.info = info;
				file.url = url;
				file.dest = dest;
				file.currentPath = currentPath;
				var request = http.get(url, function(response) {
					response.pipe(file);
					file.on('finish', function() {
						debugger;
						file.close();
						switch (getExtension(this.dest + '/' + this.url.split('/')[this.url.split('/').length - 1])) {
							case 'zip':
								fs.createReadStream(this.dest + '/' + this.url.split('/')[this.url.split('/').length - 1]).pipe(unzip.Extract({ path: this.dest}));
								break;

							case 'tar.bz2':
								console.log('We don\'t support tar.bz2 yet!')
								return;

							case 'tar.bz':
								console.log('We don\'t support tar.bz yet!')
								return;

							case 'tar.gz':
								console.log('We don\'t support tar.gz yet!')
								return;
						}
						fs.unlinkSync(this.dest + '/' + this.url.split('/')[this.url.split('/').length - 1]);
						executeParser(this.info, this.currentPath);
					});
				});
			}

			function getExtension(filename) {
			    var ext = path.extname(filename||'').split('.');
			    return ext[ext.length - 1];
			}


			function executeParser(info, currentPath) {
				switch (getExtension(info.executable)) {
					case "js":
						runJSParser(info, currentPath);
						break;
					//eventually support other parser types, maybe.

					default:
						alert('File extension `' + getExtension(info.executable) + '` not supported!');
						break;
				}
			}

			function runJSParser(info, currentPath) {
				var execPath = info.executable.charAt(0) == '/' ? info.executable : '/' + info.executable;
				if (fs.existsSync(currentPath + execPath)){
					var sandbox = {
						fs: {
							openSync:function(path, opts) {
								if (path.charAt(0) != '/') {
									path = '/' + path;
								}
								if (isFileInDirectory(process.cwd() + '/plugins',  path)) {
									return fs.openSync(path, opts);
								}
							},
							appendFileSync:function(path, str) {
								debugger;
								if (path.charAt(0) != '/') {
									path = '/' + path;
								}
								if (isFileInDirectory(process.cwd() + '/plugins',  path)) {
									return fs.appendFileSync(path, str);
								}
								return false;
							},
							renameSync:function(path, newPath) {
								if (path.charAt(0) != '/') {
									path = '/' + path;
								}
								if (newPath.charAt(0) != '/') {
									newPath = '/' + newPath;
								}
								if (isFileInDirectory(process.cwd() + '/plugins',  path) && isFileInDirectory(process.cwd() + '/plugins',  newPath)) {
									return fs.renameSync(path, newPath);
								}
								return false;
							},
							writeFileSync:function(path, string) {
								if (path.charAt(0) != '/') {
									path = '/' + path;
								}
								if (isFileInDirectory(process.cwd() + '/plugins',  path)) {
									return fs.writeFileSync(path, string);
								}
								return false;
							},
							readFileSync:function(path) {

								if (path.charAt(0) != '/') {
									path = '/' + path;
								}

								if (isFileInDirectory(process.cwd() + '/plugins', path)) {
									return fs.readFileSync(path);
								}
								return false;
							},
							unlinkSync:function(path) {
								if (path.charAt(0) != '/') {
									path = '/' + path;
								}

								if (isFileInDirectory(process.cwd() + '/plugins', path)) {
									return fs.unlinkSync(path);
								}
								return false;
							},
							readdirSync:function(dir) {
								if (dir.charAt(0) != '/') {
									dir = '/' + dir;
								}

								if (isFileInDirectory(process.cwd() + '/plugins', dir)) {
									return fs.readdirSync(dir);
								}
								return false;
							},
							statSync:function(filepath) {
								if (filepath.charAt(0) != '/') {
									filepath = '/' + filepath;
								}

								if (isFileInDirectory(process.cwd() + '/plugins', filepath)) {
									return fs.statSync(filepath);
								}
								return false;
							},
							existsSync:function(filepath) {
								if (filepath.charAt(0) != '/') {
									filepath = '/' + filepath;
								}

								if (isFileInDirectory(process.cwd() + '/plugins', filepath)) {
									return fs.existsSync(filepath);
								}
								return false;
							}
						},
						htmlparser:require('htmlparser2'),
						finished:0,
						__dirname:currentPath
					};
					setTimeout(function(){
							vm.runInNewContext(fs.readFileSync(currentPath + execPath).toString(), sandbox);
							updatePluginsJSON(info.name, {
								folder:currentPath.substr((process.cwd() + '/plugins').length),
								name:info.name,
								executable:info.executable,
								lastUpdated:new Date(),
							});
						}, 0
					);
					// console.log(util.inspect(sandbox)); 
				}
			}

			function updatePluginsJSON(name, modifications) {
				var JSONToWrite = JSON.parse(fs.readFileSync(process.cwd() + '/plugins/plugins.json').toString());
				JSONToWrite.forEach(function(o){
					if (o.name == name) {
						for (var i in modifications) {
							o[i] = modifications[i];
						}
						fs.writeFileSync(process.cwd() + '/plugins/plugins.json', JSON.stringify(JSONToWrite));
						return;
					}
				});

				JSONToWrite.push({
					folder:modifications.name,
					name:modifications.name,
					executable:modifications.executable,
					lastUpdated:modifications.lastUpdated,
					activated:1
				});

				fs.writeFileSync(process.cwd() + '/plugins/plugins.json', JSON.stringify(JSONToWrite));
				return;
			}

			function isFileInDirectory(a, b) { //directory, file 
				if (!fs.existsSync(a)) {
					return false;
				}
				var previouslyExisted = 1;
				if (!fs.existsSync(b)) { //if it didn't previously exist
					try {
						fs.writeFileSync(b, '') //make a few file
						previouslyExisted = 0;
					}
					catch (err) {
						throw err;
					}
				}
				if (b.indexOf(a) == 0) {
					var ap = fs.realpathSync(a); //get true paths
					var bp = fs.realpathSync(b);
					if (!previouslyExisted) {
						fs.unlinkSync(b); //if it didn't previously exist, delete it
					}
					if (bp.indexOf(ap) == 0) {
						return true;
					}
					else {
						return false ;
					}	
				}
				if (!previouslyExisted) {
					fs.unlinkSync(b); //if it didn't previously exist, delete it
				}
				return false;
			}

			function doesInfoFileExist() {
				if (!fs.existsSync(process.cwd() + '/plugins/plugins.json')) {
					fs.writeFileSync(process.cwd() + '/plugins/plugins.json', '{plugins:[]}');
				}
			}

			//should be in index.html for the actual parsing
			function getDocs() {
				var dirs = [];
				var currentPath = process.cwd() + "/plugins/";
				var overallInfo = JSON.parse(fs.readFileSync(process.cwd() + "/plugins/").toString());
				var docs = [];

				overallInfo.forEach(function(o) {
					docs.push(o.folder);
				})

				dirs.forEach(function(o) {
					var foldersInDocs = fs.readdirSync(currentPath + o);
					if (foldersInDocs.indexOf('output') != -1) {
						if (fs.statSync(currentPath + o + '/output/').isDirectory()) {
							var itemsInOutput = fs.readdirSync(currentPath + o + '/output/');
							if (itemsInOutput.indexOf('output.json') != -1) {
								if (!fs.statSync(currentPath + o + '/output/output.json').isDirectory()) {
									docs.push(JSON.parse(fs.readFileSync(currentPath + o + '/output/output.json').toString()));
								}
							}
							else {
								itemsInOutput.forEach(function(file){
									if (getExtension(currentPath + o + '/output/' + file) == "json") {
										docs.push(JSON.parse(fs.readFileSync(currentPath + o + '/output/' + file).toString()));
									}
								})
							}
						}
					}
				});
				console.log(docs);
				return docs;
			}

			function getExtension(filename) {
				var ext = path.extname(filename||'').split('.');
				return ext[ext.length - 1];
			}

			function updateDocs() {
				var spinner = makeCustomSpinner();
				this.row.append(spinner.el);
				//
			}

			function makeCustomSpinner() {
				var opts = {
					lines: 10, // The number of lines to draw
					length: 5, // The length of each line
					width: 3, // The line thickness
					radius: 3, // The radius of the inner circle
					corners: 2, // Corner roundness (0..1)
					rotate: 0, // The rotation offset
					direction: 1, // 1: clockwise, -1: counterclockwise
					speed: 1, // Rounds per second
					trail: 60, // Afterglow percentage
					shadow: false, // Whether to render a shadow
					hwaccel: false, // Whether to use hardware acceleration
					className: 'spinner', // The CSS class to assign to the spinner
					zIndex: 2e9, // The z-index (defaults to 2000000000)
					top: 'auto', // Top position relative to parent in px
					left: 'auto' // Left position relative to parent in px
				};

				var spinner = new Spinner(opts).spin();
				// $(spinner.el).css('position', 'abso');
				$(spinner.el).css('right', '175px');
				$(spinner.el).css('margin-top', '8px');
				$(spinner.el).css('background-color', '#FFFFFF');
				// $(spinner.el).css('bottom', '9px');
				return spinner;
			}
		</script>
	</body>
</html>
